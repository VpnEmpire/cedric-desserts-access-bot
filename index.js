const TelegramBot = require("node-telegram-bot-api");

// ‚ö†Ô∏è BOT_TOKEN –º—ã –ù–ï –ø–∏—à–µ–º –≤ –∫–æ–¥–µ, –æ–Ω –±—É–¥–µ—Ç –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Vercel
const token = process.env.BOT_TOKEN;

if (!token) {
  throw new Error("–ù–µ –∑–∞–¥–∞–Ω BOT_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.");
}

// —Å–æ–∑–¥–∞—ë–º –±–æ—Ç–∞ –ë–ï–ó polling, –º—ã —Ä–∞–±–æ—Ç–∞–µ–º —á–µ—Ä–µ–∑ webhook
const bot = new TelegramBot(token, { polling: false });

// —Ç–≤–æ–π –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª —Å —Ä–µ—Ü–µ–ø—Ç–∞–º–∏
const PRIVATE_CHANNEL_LINK = "https://t.me/+8xj6svJzs0YzODcy";

// –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const firstName = msg.from?.first_name || "–∫–æ–Ω–¥–∏—Ç–µ—Ä";

  const text =
    `–ü—Ä–∏–≤–µ—Ç, ${firstName} üíõ\n\n` +
    `–≠—Ç–æ –±–æ—Ç-–¥–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É –∫–∞–Ω–∞–ª—É —Å –∫–æ—Ä–ø—É—Å–Ω—ã–º–∏ –¥–µ—Å–µ—Ä—Ç–∞–º–∏ –∏ —Ä–µ—Ü–µ–ø—Ç–∞–º–∏ –≤ —Å—Ç–∏–ª–µ C√©dric Grolet –∏ –Ω–µ —Ç–æ–ª—å–∫–æ.\n\n` +
    `üí≥ –í—Ö–æ–¥ –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª ‚Äî *1490 ‚ÇΩ* (—Ä–∞–∑–æ–≤–æ).\n` +
    `–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç—ã –Ω–∞–≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—à—å –¥–æ—Å—Ç—É–ø:\n` +
    `‚Ä¢ –∫–æ –≤—Å–µ–º —Ç–µ–∫—É—â–∏–º —Ä–µ—Ü–µ–ø—Ç–∞–º\n` +
    `‚Ä¢ –∫–æ –≤—Å–µ–º –Ω–æ–≤—ã–º —Ä–µ—Ü–µ–ø—Ç–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è.\n\n` +
    `–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –æ–ø–ª–∞—Ç–µ –∏ –¥–æ—Å—Ç—É–ø.`;

  await bot.sendMessage(chatId, text, {
    parse_mode: "Markdown",
    reply_markup: {
      inline_keyboard: [
        [{ text: "üí≥ –ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø", callback_data: "HOW_TO_PAY" }]
      ]
    }
  });
});

// –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
bot.on("callback_query", async (query) => {
  const chatId = query.message.chat.id;
  const data = query.data;

  if (data === "HOW_TO_PAY") {
    const payText =
      "üí≥ *–ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å –¥–æ—Å—Ç—É–ø (1490 ‚ÇΩ)*\n\n" +
      "1Ô∏è‚É£ –û–ø–ª–∞—Ç–∏ 1490 ‚ÇΩ —Ç–µ–º —Å–ø–æ—Å–æ–±–æ–º, –∫–æ—Ç–æ—Ä—ã–π —è —É–∫–∞–∂—É –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ (–ÆKassa / –ø–µ—Ä–µ–≤–æ–¥ / —Å–∞–π—Ç –æ–ø–ª–∞—Ç—ã).\n" +
      "2Ô∏è‚É£ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–∏—à–ª–∏ —á–µ–∫ –∏–ª–∏ —Å–∫—Ä–∏–Ω –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç—É–¥–∞, –∫—É–¥–∞ —Ç—ã —Ä–µ—à–∏—à—å –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –ª—é–¥–µ–π ‚Äî Instagram, Telegram –∏ —Ç.–ø.).\n" +
      "3Ô∏è‚É£ –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã —Ç—ã –ø–æ–ª—É—á–∏—à—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª:\n\n" +
      `üëâ ${PRIVATE_CHANNEL_LINK}\n\n` +
      "_–ü–æ–∑–∂–µ —Å—é–¥–∞ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ÆKassa, –Ω–æ —É–∂–µ —Å–µ–π—á–∞—Å –±–æ—Ç –¥–∞—ë—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª._";

    await bot.sendMessage(chatId, payText, {
      parse_mode: "Markdown",
      disable_web_page_preview: true
    });
  }
});

// —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ webhook-—Ñ—É–Ω–∫—Ü–∏–∏ Vercel
function handleUpdate(update) {
  bot.processUpdate(update);
}

module.exports = { handleUpdate };

